<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:controls="clr-namespace:ShoppingList.Views.Controls"
    x:Class="ShoppingList.Views.ShoppingListPage"
    Title="Lista zakupów">

  <ContentPage.ToolbarItems>
    <ToolbarItem Text="Eksport" Command="{Binding ExportCommand}" />
    <ToolbarItem Text="Import" Command="{Binding ImportCommand}" />
  </ContentPage.ToolbarItems>

  <Grid Padding="10">
    <!-- Główna zawartość strony -->
    <Grid IsEnabled="{Binding IsInitialized}">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <!-- Panel filtrów i dodawania kategorii -->
      <StackLayout Orientation="Vertical" Spacing="8" Grid.Row="0">
        <StackLayout Orientation="Horizontal" Spacing="8">
          <Entry Text="{Binding ShopFilterText}" Placeholder="Filtruj po sklepie" HorizontalOptions="FillAndExpand"/>
          <Button Text="Wyczyść" Command="{Binding ClearShopFilterCommand}" />
        </StackLayout>
        <StackLayout Orientation="Horizontal" Spacing="8">
          <Entry x:Name="CategoryEntry" Placeholder="Nowa kategoria" HorizontalOptions="FillAndExpand"/>
          <Button Text="Dodaj kategorię"
                  Command="{Binding AddCategoryCommand}"
                  CommandParameter="{Binding Source={x:Reference CategoryEntry}, Path=Text}" />
        </StackLayout>

        <StackLayout Orientation="Horizontal" Spacing="8">
          <Button Text="Sortuj - nazwa" Command="{Binding SortByNameCommand}" />
          <Button Text="Sortuj - ilość" Command="{Binding SortByQuantityCommand}" />
        </StackLayout>
      </StackLayout>

      <!-- Główny scroll: wszystkie kategorie + produkty w jednym ScrollView -->
      <ScrollView Grid.Row="1">
        <VerticalStackLayout Spacing="8"
                             BindableLayout.ItemsSource="{Binding Categories}">
          <BindableLayout.ItemTemplate>
            <DataTemplate>
              <Frame Padding="8" Margin="6" HasShadow="True" IsVisible="{Binding HasFilterMatch}">
                <Grid RowDefinitions="Auto,Auto">
                  <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto">
                    <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="16" Grid.Column="0" VerticalOptions="Center"/>
                    <Button Grid.Column="1" Command="{Binding ToggleExpandCommand}" Text="Rozwiń" VerticalOptions="Center">
                      <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding IsExpanded}" Value="True">
                          <Setter Property="Text" Value="Zwiń" />
                        </DataTrigger>
                      </Button.Triggers>
                    </Button>
                    <Button Grid.Column="2"
                            Text="Usuń"
                            TextColor="Red"
                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteCategoryCommand}"
                            CommandParameter="{Binding .}" />
                  </Grid>

                  <!-- pola dodawania produktu i lista produktow widocna tylko gdy IsExpanded == true -->
                  <StackLayout Grid.Row="1" IsVisible="{Binding IsExpanded}">
                    <StackLayout Orientation="Horizontal" Spacing="6" Margin="0,6,0,6">
                      <Entry Placeholder="Nazwa produktu" Text="{Binding NewProductName}" HorizontalOptions="FillAndExpand"/>
                      <Entry Placeholder="Jednostka" WidthRequest="80" Text="{Binding NewProductUnit}" />
                      <Entry Placeholder="Ilość" WidthRequest="70" Keyboard="Numeric" Text="{Binding NewProductQuantity}" />
                      <Button Text="+ Dodaj" Command="{Binding AddProductCommand}" />
                    </StackLayout>

                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding FilteredProducts}" Spacing="4">
                      <BindableLayout.ItemTemplate>
                        <DataTemplate>
                          <controls:ProductView />
                        </DataTemplate>
                      </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>
                  </StackLayout>
                </Grid>
              </Frame>
            </DataTemplate>
          </BindableLayout.ItemTemplate>

          <!-- dolny zapas, żeby można było przewinąć poniżej ostatniej kategorii -->
          <BoxView HeightRequest="40" Opacity="0" />
        </VerticalStackLayout>
      </ScrollView>
    </Grid>

    <!-- overlay ładowania -->
    <Grid BackgroundColor="Black" Opacity="0.1" IsVisible="{Binding IsInitializing}" InputTransparent="False" />
    <ActivityIndicator IsRunning="True" IsVisible="{Binding IsInitializing}" HorizontalOptions="Center" VerticalOptions="Center" />
  </Grid>
</ContentPage>
